---
title: "Assignment3_ds"
format: html
editor: visual
bibliography: my_bib.bib
---

## **Assignment 3 -** **Pendling**

```{r}
#| label: setup 
#| echo: false
#| output: false
#| message: false
library(tidyverse)
library(tidyselect)
library(lubridate)
library(PxWebApiData)
library(flextable)
library(readr)
```

### Importere data

Dataene er hente fra SSB sin statistikktabell 03321, «*Sysselsatte (15-74 år), etter arbeidssteds- og bostedskommune. Pendlingsstrømmer. 4. kvartal (K) 2000 - 2022*» **()**.
Dataene fra SSB har vi hente direkte inn i R via pakken `PxWebApiData`, som gir oss tilgang til SSB via en api:

```{r}
# Henter data for arbeidstakere som jobber på Haugalandet med bostedskommune fordelt over hele landet
pend_00_22_ssb_arbHland <- ApiData(
  "https://data.ssb.no/api/v0/no/table/03321/", 
  returnMetaFrames = TRUE
)
```

```{r}
# Henter data for arbeidstakere som bor på Haugalandet og jobber i kommuner over hele landet
pend_00_22_ssb_boHland <- ApiData(
  "https://data.ssb.no/api/v0/no/table/03321/", 
  returnMetaFrames = TRUE
)
```

Videre har vi hentet arbeidstakere som bor på Haugalandet, jobber i kommuner over hele landet for perioden 2000-2022.
Vi har benytt funksjonen `PxWebApiData::ApiData12()` med ulike argumenter.
Det samme gjorde vi for antall arbeidstakere som jobber på Haugalandet med bosteds-kommune fordelt over hele landet

```{r}
#| cache: true
# Definer kommunenumrene for Haugalandet
kommuner_på_Haugalandet <- c("1106", "1135", "1145", "1149", "1154", "1159", "1160", "4611", "4612", "1211", "1216")

# Hent alle kommunenumrene i landet (du må erstatte dette med den faktiske listen)
alle_kommuner_i_landet <- c(0101:9999)

# Lager en vektor med årene fra 2000 til 2022
år <- as.character(2000:2022)

# Angir tabellnummeret 
tabellnummer <- "03321"

# Henter data for arbeidstakere som jobber på Haugalandet med bostedskommune fordelt over hele landet
pend_00_22_ssb_arbHland <- PxWebApiData::ApiData12(
  urlToData = tabellnummer,
  ArbstedKomm = kommuner_på_Haugalandet,
  Bokommuen = alle_kommuner_i_landet,
  Tid = år
)

# Henter data for arbeidstakere som bor på Haugalandet og jobber i kommuner over hele landet
pend_00_22_ssb_boHland <- PxWebApiData::ApiData12(
  urlToData = tabellnummer,
  ArbstedKomm = alle_kommuner_i_landet,
  Bokommuen = kommuner_på_Haugalandet,
  Tid = år
)


# Skriv ut rådataene for begge tilfellene
print(pend_00_22_ssb_boHland)
print(pend_00_22_ssb_arbHland)
```

Derretter lager vi vår egen reduserte versjon av datasettene hvor vi kunn ønsker å ta med: år, arbeidsstedskommune, bokommune og antall pendlere.
Dette gjelder for begge datasettene.

**\--\> "*Vi bryr oss altså ikke om kommunenummer i det videre arbeidet og jobber bare med kommunenavn som kategorivariabler*"??**?

```{r}
Arbeid <- pend_00_22_ssb_arbHland |> 
  select(aar = år, arb_kom = arbeidsstedskommune, bo_kom = bostedskommune, pendlere = value)
```

```{r}
Bosted <- pend_00_22_ssb_boHland |> 
  select(aar = år, bo_kom = bostedskommune, arb_kom = arbeidsstedskommune, pendlere = value)
```

\--\> "***Vi må så konvertere `arb_kom` og `bo_kom` til kategorivariabler vha. `fct()` funksjonen. Hver av disse variablene skal så kollapses til kategoriene `Haugesund`, `Sauda`, `Bokn`, `Tysvær`, `Karmøy`, `Vindafjord` og `Ølen`. Vi gjør dette ved å bruke `fct_collapse()` funksjonen. Vi må også sørge for at hhv. `Ølen` og `Vindafjord` blir slått sammen til en kategori fra sine «gamle» versjoner. Vi samler kommunene utenfor Haugalandet i kategorien «Andre» vha. argumentet `other_level = "Andre"`. Overskriv `arb_kom` og `bo_kom` med sine kollapsede versjoner." ???***

```{r}
Arbeid1 <- Arbeid |> 
  mutate(
    arb_kom = fct(arb_kom),
    arb_kom = fct_collapse(
      .f = arb_kom,
      "Haugesund" = "Haugesund",
      "Sveio" = c("Sveio", "Sveio (-2019)"),
      "Karmøy" = "Karmøy",
      "Bokn" = "Bokn",
      "Tysvær" = "Tysvær",
      "Sauda" = "Sauda",
      "Vindafjord" = c("Vindafjord", "Vindafjord (1965-2005)", "Ølen (2002-2005)"),
      "Etne" = c("Etne (-2019)", "Etne"),
      other_level = c("Andre")
    )
  ) 
```

```{r}
Bosted1 <- Bosted |> 
  mutate(
    bo_kom = fct(bo_kom),
    arb_kom = fct(arb_kom),
    bo_kom = fct_collapse(
      .f = bo_kom,
      "Haugesund" = "Haugesund",
      "Sveio" = c("Sveio", "Sveio (-2019)"),
      "Karmøy" = "Karmøy",
      "Bokn" = "Bokn",
      "Tysvær" = "Tysvær",
      "Sauda" = "Sauda",
      "Vindafjord" = c("Vindafjord", "Vindafjord (1965-2005)", "Ølen (2002-2005)"),
      "Etne" = c("Etne (-2019)", "Etne"),
      other_level = c("Andre")
    )
  ) 
```
